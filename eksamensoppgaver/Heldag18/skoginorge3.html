<!doctype html>
<html>
	<head>
		<title>Skog i Norge -  Oppgave 3</title>
		<meta charset="utf-8" />
		<link href="css/hovedstil.css" rel="stylesheet" type="text/css">
		<link href="css/table.css" rel="stylesheet" type="text/css">
		<style media="screen">
		#graf {
			display: none;
			background-color: white;
			padding: 5px 20px 20px 20px;
			border-radius: 7px;
		}
		#graf div {
			display: flex;
			justify-content: center;
		}
		#graf div div{
			display: grid;
			grid-column: 1;
			grid-row: 2;
			grid-template-rows: 90% 10%;
			align-content: end;
			align-items: flex-end;

			margin: 10px;
			/* background-color: #eee; */
			min-height: 250px;
			text-align: left;
		}
		.stolpe {
			position: relative;
			bottom: 0;
			text-align: center;
			font-size: 10pt;
			/* color: rgb(27,255,54); */
			background-color: rgb(27,255,54);
			width: 100%;
		}
	  .divDrp  {
			display: none;
		}
		button:not(:last-child) {
			margin-bottom: 10px;
		}
		input[type='text'],select {
		  height: 46px;
			margin-top: 10px;
		  padding: 0 16px;
		  font-size: 18px;
		  line-height: 1.3333333;
		  width: 100%;
		  /* border: 2px solid #ff7f82; */
		}
		</style>
		<script type="text/javascript">
	  // Globale variabler
		const tabell = [
			{tresort: '', aar1915: '', aar1950: '', aar1970: '', aar1990: '', aar1995: '', aar2000: ''},
			{tresort: 'Furu', aar1915: 20, aar1950: 31, aar1970: 53, aar1990: 89, aar1995: 102, aar2000: 117},
			{tresort: 'Gran', aar1915: 23, aar1950: 39, aar1970: 72, aar1990: 89, aar1995: 92, aar2000: 99},
			{tresort: 'Lauvtre', aar1915: 4, aar1950: 6, aar1970: 8, aar1990: 12, aar1995: 16, aar2000: 18},
		];
		// DOM elementer
		let divButton, table, graf, divDropdown, btnBeregn;
		window.onload = () => {
			divButton = document.getElementById('divButton');
			table = document.getElementById('table');
			graf = document.getElementById('graf');
			divDropdown = document.getElementById('divDropdown');
			btnBeregn = document.getElementById('btnBeregn');
			// Lager knappene for tresortene, tabellen kan dermed utvides
			createButton(tabell,divButton);
			// Events, knapp for å beregne økningen mellom to valgte år for en tresort
			btnBeregn.onclick = () => finnOkning();
		}
		// Funksjoner for å create DOM elementer
		// Lager knappene for tresortene
		function createButton(tabell,divButton) {
			// Looper gjennom tabellen *utenom* index = 0
			for (let i = 1; i < tabell.length; i++) {
				let btn = document.createElement('button');
				// Filtert tabell for å tegne graf, tar med TH
				let nytabell = tabell.filter(x => x.tresort == tabell[i].tresort || x.tresort == '')
				btn.innerHTML = tabell[i].tresort;
				btn.onclick = () => {
					// filtrerer alt vekk, tar bare 1 tresort for hver knapp sitt event, vekk med TH
					let valgTre = nytabell.filter(x => x.tresort == tabell[i].tresort);
					createTable(nytabell,table);
					createGraf(valgTre,graf,tabell[i].tresort);
					createDropdown(valgTre, divDropdown, tabell[i].tresort)
				}
				divButton.appendChild(btn);
			}
		}
		// Lager dropdowns etter valg av tresort, for å beregne økning mellom valgt år
		function createDropdown(objArr,output, name) {
			// reset
			output.innerHTML = '';
			// Henter årstall, setter dem i select > option tags
			let arr = Object.keys(objArr[0])
			for (let i = 0; i < 2; i++) {
				let select = document.createElement('select');
				for (let j = 1; j < arr.length; j++) {
					let option = document.createElement('option');
					option.innerHTML = arr[j].replace('aar','');
					option.value = arr[j];
					select.appendChild(option);
				}
				select.className = 'dropDown'
				select.name = name;
				output.insertBefore(select, output.childNodes[0])
				output.parentNode.style.display = 'block';
			}
		}
		// Lager visuelt tabell med createElement
		function createTable(objArr,output) {
			output.innerHTML = '';
			let keys = Object.keys(objArr[0]);
			// Looper gjennom verdiene til valgt/filtrert tresort
			for (let i = 0; i < objArr.length; i++) {
				let values = Object.values(objArr[i]);
				let tr = document.createElement('tr');
				for (let j = 0; j < values.length; j++) {
					let td = (i > 0) ? (document.createElement('td')) : (document.createElement('th'))
					td.innerHTML = (i > 0) ? (values[j]) : (keys[j].toUpperCase().replace('AAR','')); // Overskrift som store bokstaver
					tr.appendChild(td);
				}
				output.appendChild(tr);
			}
		}
		// Lager visuelt graf med createElement
		function createGraf(objArr, output, title) {
			output.innerHTML = '';
			// Keys for å finne tekst
			let keys = Object.keys(objArr[0]);
			let h2 = document.createElement('h2');
			h2.innerHTML = title;
			output.appendChild(h2);
			let bigDiv = document.createElement('div');
			for (let i = 0; i < objArr.length; i++) {
				// Values for å finne verdi
				let values = Object.values(objArr[i]);
				for (let j = 1; j < values.length; j++) {
					let div = document.createElement('div');
					let span1 = document.createElement('span');
					let span2 = document.createElement('span');
					span1.innerHTML = keys[j].replace('aar','');
					span2.innerHTML = values[j];
					span2.className = 'stolpe';
					span2.style.height = `${values[j]+15}px`;
					div.appendChild(span2);
					div.appendChild(span1);
					bigDiv.appendChild(div);
				}
			}
			output.appendChild(bigDiv);
			output.style.display = 'block';
			minMax(objArr,output);
		}
		// Skrive/legge til tekst i DOM
		function writeText(msg,output,type=false) {
			if (type) output.innerHTML = '';
			output.innerHTML += `<p>${msg}</p>`;
		}
		// Finner gj.øknings verdiene
		function finnOkning() {
			// Henter DOMs
			let nodes = document.getElementsByClassName('dropDown');
			let tekst = document.getElementById('beregnTekst');
			// Velger den valgte tresorten
			let sjekkTabell = tabell.filter(x => x.tresort == nodes[0].name)[0];
			let sjekk = []
			for (var i = 0; i < nodes.length; i++) {
				let verdi = nodes[i].value;
				sjekk.push(sjekkTabell[verdi]);
			}
			// Tar differansen mellom verdiene
			let okning = sjekk[1] - sjekk[0];
			writeText(`"${sjekk[0]} - ${sjekk[1]}"<br/>Den gjennomsnittlig økningen er: ${okning} millioner [${Math.round(okning/sjekk[0] * 100)}% av ${sjekk[0]}]`,tekst,true)
			console.log(sjekk)
		}
		// Finner gj. min/maks for differansen per år
		function minMax(objArr,output) {
			let arr = Object.entries(objArr[0])
			// Finner alle differanser, lagrer også indexene
			let array = [];
			for (let i = 1; i < arr.length-1; i++) {
				let diff = [0,0,0];
				diff[0] = (arr[i+1][1] - arr[i][1])
				diff[1] = i;
				diff[2] = i+1;
				array.push(diff);
			}
			// Sorterer differansen for å finne maks og min
			let differans = array.sort((a,b) => a[0] - b[0])
			let maks = differans[differans.length-1]
			let min = differans[0]
			let minVerdier = {fra: arr[min[1]][0].replace('aar',''), til: arr[min[2]][0].replace('aar',''), verdi: min[0]};
			let maksVerdier = {fra: arr[maks[1]][0].replace('aar',''), til: arr[maks[2]][0].replace('aar',''), verdi: maks[0]};
			writeText(`Minst gjennomsnittlig økning: ${minVerdier.fra} - ${minVerdier.til} på ${minVerdier.verdi} millioner
				<br/>Størst gjennomsnittlig økning: ${maksVerdier.fra} - ${maksVerdier.til} på ${maksVerdier.verdi} millioner`,output)
		}

		</script>
	</head>
	<body>
		<header>
			<p><a href="index.html">⌂ Heldag 2018</a> - Oppgave 3</p>
		</header>
		<main id="main">
			<br>
			<div class="content">
				<h1>Statistikk over grove trær i Norge</h1>
				<p>
				Tabell (utvikling av grove trær i Norge):
				</p>
				<div id="divButton">

				</div>
				<br>

				<table id='table'>
				</table>
				<br>

				<div id="graf">
				</div>

				<div class='divDrp'>
					<hr>
					<h3>Finn økningen mellom to valgte år i tallverdi og prosent</h3>
					<div id="divDropdown">
					</div>
					<p id='beregnTekst'></p>
					<button id="btnBeregn">Beregn</button>
				</div>
				</p>
			</div>
		</main>
		</br>
	</body>
</html>
