<!doctype html>
<html>
	<head>
		<title>Skolevalg -  Oppgave 3</title>
		<meta charset="utf-8" />
		<link href="css/hovedstil.css" rel="stylesheet" type="text/css">
		<link href="css/table.css" rel="stylesheet" type="text/css">
		<style media="screen">
			button {
				width: auto;
			  height: 46px;
			  background: none;
			  border: 2px solid rgba(15, 187, 125, 1);
			  padding: 0 16px;
			  color: rgba(15, 187, 125, 1);
			  cursor: pointer;

			  font-size: 18px;
			  font-weight: bold;
			  line-height: 1.42857143;
			  line-height: 1.3333333;

			  transition: 1s;
			}
			button:hover, button:focus, button:disabled {
			  box-shadow: inset 0 0 0 2em rgba(51, 202, 153, 1);
			  color: white;
			}
			input[type='text'],select {
			  height: 46px;
				margin-top: 10px;
			  padding: 0 16px;
			  font-size: 18px;
			  line-height: 1.3333333;
			  width: 70%;
			}
			#stemmeBox {
				visibility: hidden;
				display: flex;
				justify-content: center;
				position: absolute;
			  top: 50%;
			  left: 50%;
			  transform: translate(-50%,-50%);
			  z-index: 9999;
				text-align: center;

				width: calc(100% - 50px);
				height: calc(100% - 50px);
				background: rgba(220,220,255,1);
			  border-radius: 20px;
				opacity: 0;
			  transition: visibility 0.5s, opacity 0.5s ease-in-out;
			}
			#stemmeBox div {
			  position: relative;
				width: 60%;
				height: 100%;
				overflow: auto;
			}
			#table {
				position: relative;

			}
			#table td {
				text-align: center;
				cursor: pointer;
			}
			#stemmeBox div img {
				width: 50px;
			}
			#btnFerdig {
				position: absolute;
				top: 10px;
				right: 10px;
			}
		</style>
		<script type="text/javascript">
			const systemParti = [
				{img: '', parti: '', prosent: '', prosent2013: ''},
				{img: 'vedlegg/raudt.jpg', parti: 'Rødt', prosent: 0, prosent2013: 3.7},
				{img: 'vedlegg/sv.jpg', parti: 'SV', prosent: 0, prosent2013: 5},
				{img: 'vedlegg/ap.jpg', parti: 'A', prosent: 0, prosent2013: 23.0},
				{img: 'vedlegg/sp.jpg', parti: 'SP', prosent: 0, prosent2013: 4.2},
				{img: 'vedlegg/miljopartiet.jpg', parti: 'MDG', prosent: 0, prosent2013: 3.8},
				{img: 'vedlegg/krf.jpg', parti: 'KrF', prosent: 0, prosent2013: 2.8},
				{img: 'vedlegg/venstre.jpg', parti: 'V', prosent: 0, prosent2013: 6.7},
				{img: 'vedlegg/hoyre.jpg', parti: 'H', prosent: 0, prosent2013: 23.8},
				{img: 'vedlegg/frp.jpg', parti: 'FrP', prosent: 0, prosent2013: 15.6},
				{img: 'vedlegg/piratpartiet.jpg', parti: 'PIR', prosent: 0, prosent2013: 4.3},
			];
			let systemPassord = [
				'Passord001',
				'Passord002',
				'Passord003',
				'Passord004',
				'Passord005',
				'Passord006',
				'Passord007',
				'Passord008',
				'Passord009',
				'Passord010',
			];
			let userInput, loginBtn, loginMsg, stemmeBox, stemmeTabell, stemmeMsg, btnBekreft, btnAktiver, btnFerdig;
			window.onload = () => {
				userInput = document.getElementById('input');
				loginBtn = document.getElementById('btn');
				loginMsg = document.getElementById('message');

				stemmeBox = document.getElementById('stemmeBox');
				stemmeTabell = document.getElementById('table');
				stemmeMsg = document.getElementById('stemmeMsg');
				btnBekreft = document.getElementById('btnBekreft');

				btnAktiver = document.getElementById('btnAktiver');
				btnFerdig = document.getElementById('btnFerdig');
				btn.onclick = () => login(userInput.value,systemPassord);
				btnBekreft.onclick = function() {
					if (this.value == '') return writeMsg('Velg en stemme!',stemmeMsg)
					writeMsg('Stemmen er gitt i systemet!<br/>Videresendes tilbake til innloggingssiden...',stemmeMsg);
					btnBekreft.disabled = true;
					setTimeout(() => {
						openClose(false,stemmeBox);
						leggTilValg(this.value);
					},2000)
				};
				btnAktiver.onclick = () => opptelling(systemParti);
				btnFerdig.onclick = () => openClose(false,stemmeBox);
				// leggTilValg('FrP')
			}
			function opptelling(objArr) {
				let reducer = (acc, cur) => acc + cur;
				let arrFiltered = objArr.filter(x => x.prosent !== '');
				let totalStemme = arrFiltered.map(x => x.prosent).reduce(reducer);
				let arrStemme = objArr.map(obj => {
					clonedObj = {...obj}
				  clonedObj.prosent = ((clonedObj.prosent/totalStemme)*100).toFixed(1);
					clonedObj.endring = (clonedObj.prosent-clonedObj.prosent2013).toFixed(1);
				  return clonedObj;
				});
				// console.log(objArr);
				// console.log(copyObjArr,arrFiltered,totalStemme,arrStemme);
				resultatTabell(arrStemme,stemmeTabell);
			}
			function resultatTabell(objArr,output) {
				resetColorTable();
				output.innerHTML = '';
				for (let i = 0; i < objArr.length; i++) {
					let entries = Object.entries(objArr[i]);
					let tableR = document.createElement('tr');
					for (let j = 0; j < entries.length; j++) {
						let tableC = (i == 0) ? (document.createElement('th')) : (document.createElement('td'))
						tableC.innerHTML = (i == 0) ? (entries[j][0]) : (entries[j][1]);
						if (j == 0) tableC.innerHTML = `<img src="${entries[j][1]}"/>`;
						tableR.appendChild(tableC);
					}
					stemmeTabell.appendChild(tableR);
				}
				openClose(true,btnFerdig);
				openClose(false,btnBekreft);
				openClose(true,stemmeBox);
			}
			function leggTilValg(valg) {
				let f = systemParti.filter(x => x.parti == valg).map(obj => obj.prosent++);
				// for (let i = 0; i < systemParti.length; i++) {
				// 	if (systemParti[i].parti == valg) {
				// 		systemParti[i].prosent++;
				// 		break
				// 	}
				// }
				// console.log(f,systemParti)
			}
			function writeMsg(input,output,type=0) {
				if (type == 0) output.innerHTML = '';
				output.innerHTML += input;
			}
			function login(input,lstPassord) {
				let pwdIndex = lstPassord.indexOf(input);
				if (pwdIndex == -1) return writeMsg('Passord finnes ikke i systemet',loginMsg);
				// console.log(pwdIndex)
				lstPassord.splice(pwdIndex,1);
				// console.log(lstPassord)
				btn.disabled = true;
				writeMsg('Passord finnes i systemet!<br/>Videresendes til stemmegivingsdelen...',loginMsg);
				setTimeout(() => {
					stemmegiving(systemParti,stemmeTabell);
					writeMsg('',loginMsg)
				},2000)
			}
			function resetColorTable() {
				let nodes = document.querySelectorAll('tr');
				writeMsg('',stemmeMsg);
				for (var i = 0; i < nodes.length; i++) {
					nodes[i].style.backgroundColor = 'white';
				}
			}
			function stemmegiving(objArr,output) {
				resetColorTable();
				output.innerHTML = '';
				for (let i = 0; i < objArr.length; i++) {
					let entries = Object.entries(objArr[i]);
					let tableR = document.createElement('tr');
					for (let j = 0; j < entries.length-2; j++) {
						// console.log(entries)
						let tableC = (i == 0) ? (document.createElement('th')) : (document.createElement('td'))
						tableC.innerHTML = (entries[j][1]);
						if (j == 0) tableC.innerHTML = `<img src="${entries[j][1]}"/>`
						if (i == 0 && j == 0) tableC.innerHTML = (entries[j+1][0]);
						tableR.appendChild(tableC);
					}
					tableR.id = entries[1][1];
					if (i > 0) {
						tableR.onclick = function() {
							resetColorTable();
							writeMsg(`Du har valgt partiet: ${this.id}`,stemmeMsg);
							this.style.backgroundColor = 'aqua';
							document.getElementById('divBox').scrollTo({ top: 10000, behavior: 'smooth' });
							btnBekreft.value = this.id;
						}
					}
					output.appendChild(tableR);
				}
				btn.disabled = false;
				btnBekreft.disabled = false;
				openClose(false,btnFerdig);
				openClose(true,btnBekreft);
				openClose(true,stemmeBox);
				document.getElementById('divBox').scrollTo({ top: 0, behavior: 'smooth' });
			}
			function openClose(bool,dom) {
				if (bool) {
					dom.style.visibility = 'visible';
					dom.style.opacity = '1';
				} else {
					dom.style.visibility = 'hidden';
					dom.style.opacity = '0';
				}
			}
		</script>
	</head>
	<body>
		<header>
			<p><a href="index.html">⌂ Eksamensoppgave H2017</a> - Oppgave 2: title</p>
		</header>
		<main id="main">
			<div class="content">
				<h1>Oppgave 3: System for gjennomføring av skolevalget</h1>
				<p>
				</p>
				<div class='inputs'>
		      <input type="text" id="input" placeholder='Skriv inn gitt passord' value="">
		      <button id="btn">Login</button>
					<br><br>
					<button id="btnAktiver">Aktiver opptellingsrutine</button>
		      <p id='message'></p>
		    </div>
				<br>
			</div>
		</main>
		<!-- STEMMEBOKS -->
		<div id="stemmeBox">
			<button id="btnFerdig">X</button>
			<div id="divBox">
				<br>
				<table id='table'>
				</table>
				<p id='stemmeMsg'></p>
				<button id="btnBekreft">Bekreft stemmen</button>
				<br>
				<br>
			</div>
		</div>
		</br>
	</body>
</html>
